#!/usr/bin/env bash
# Switch Apple Terminal profile based on $PWD using $PROJECT_PROFILE_MAP
# Mapping format (newline-separated):  /path:Profile Name
# Example:
#   $HOME:Basic
#   $HOME/code/searls/posse_party:Red Sands
#   $HOME/code/searlsco/searls-auth:Man Page

set -euo pipefail

# Run only in Apple Terminal
[[ "${TERM_PROGRAM:-}" != "Apple_Terminal" ]] && exit 0

# Require mapping
map="${PROJECT_PROFILE_MAP:-}"
[[ -z "$map" ]] && exit 0

cwd="${PWD}"

_expand_path() {
  # Expand ~ and $HOME; trim trailing slash
  local p="$1"
  p="${p/#\~/$HOME}"
  p="${p%/}"
  echo "$p"
}

best_path=""
best_profile=""

# Parse newline-separated "path:profile" lines
while IFS= read -r line; do
  # Skip empty lines/comments
  [[ -z "$line" || "${line:0:1}" == "#" ]] && continue

  # Split on first colon only (profile names can contain spaces)
  IFS=':' read -r path profile <<<"$line"
  # If profile itself contains colons, rejoin them
  if [[ "$line" == *:*:* ]]; then
    profile="${line#*:}"  # everything after first colon
  fi

  [[ -z "${path:-}" || -z "${profile:-}" ]] && continue

  path="$(_expand_path "$path")"

  case "$cwd" in
    "$path"|"$path"/*)
      # Choose the most specific match (longest path prefix)
      if [[ ${#path} -gt ${#best_path} ]]; then
        best_path="$path"
        best_profile="$profile"
      fi
      ;;
  esac
done <<< "$map"

# Optional fallback if no match
if [[ -z "$best_profile" && -n "${PROJECT_PROFILE_DEFAULT:-}" ]]; then
  best_profile="$PROJECT_PROFILE_DEFAULT"
fi

# Nothing to do
[[ -z "$best_profile" ]] && exit 0

# Avoid redundant switches in this shell
if [[ "${PROJECT_PROFILE_LAST:-}" == "$best_profile" ]]; then
  exit 0
fi

# Switch profile via AppleScript
osascript >/dev/null 2>&1 <<OSA
tell application "Terminal"
  if exists (settings set "${best_profile}") then
    set current settings of selected tab of front window to settings set "${best_profile}"
  end if
end tell
OSA

# Cache last applied for this shell (PROMPT_COMMAND will keep calling us)
export PROJECT_PROFILE_LAST="$best_profile"
