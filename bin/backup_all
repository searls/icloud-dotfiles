#!/usr/bin/env bash

set -Euo pipefail

BACKUP_ALL_LOG="$(mktemp)"

echo_with_timestamp() {
  local timestamp
  timestamp=$(date "+%Y-%m-%d %H:%M:%S")
  echo "$timestamp $@"
}

send_failure_email() {
  local command_name="$1"
  local log_file="$2"
  local truncated_logs
  truncated_logs=$(tail -c 2000000 "$log_file" 2>/dev/null || printf "")
  BODY="Backup process for ${command_name} failed. Please check the logs for more information.\n\nLogs (last 2MB):\n$truncated_logs"
  {
    echo -e "$BODY" | sudo -u justin shortcuts run "send_automated_email"
  } || echo_with_timestamp "----> ⚠️ Failed to send failure email for ${command_name}"
}

on_error() {
  local exit_code=$?
  echo_with_timestamp "----> ❌ backup_all encountered a failure (exit code ${exit_code})."

  if [[ -n "${BACKUP_ALL_LOG-}" && -f "$BACKUP_ALL_LOG" ]]; then
    send_failure_email "backup_all (top-level)" "$BACKUP_ALL_LOG"
  else
    BODY="Backup process for backup_all failed before logs could be captured."
    {
      echo -e "$BODY" | sudo -u justin shortcuts run "send_automated_email"
    } || echo_with_timestamp "----> ⚠️ Failed to send top-level failure email for backup_all"
  fi
}

trap on_error ERR

exec > >(tee -a "$BACKUP_ALL_LOG") 2>&1

# Meant to be run via ~/Library/LaunchAgents/co.searls.justin.backup.plist
# Hence the hinky environment shit
export HOME="/Users/justin"
export PATH="$PATH:/usr/local/bin:/Library/Apple/usr/bin"
RECEIPTS_FOLDER="$HOME/Documents/backups/searls-studio-backup-receipts"
source "$HOME/.profile"
mkdir -p "$RECEIPTS_FOLDER"

run_backup_task() {
  local command_name="$1"
  local log_file
  log_file=$(mktemp)
  echo_with_timestamp "----> Running backup task: $command_name"

  if $command_name 2>&1 | tee "$log_file"; then
    touch "$RECEIPTS_FOLDER/$(date +%Y-%m-%d)-${command_name}-succeeded.txt"
    echo_with_timestamp "----> ✅ ${command_name} succeeded."
  else
    touch "$RECEIPTS_FOLDER/$(date +%Y-%m-%d)-${command_name}-failed.txt"
    echo_with_timestamp "----> ❌ ${command_name} failed."
    send_failure_email "$command_name" "$log_file"
  fi

  rm -f "$log_file"
}

run_backup_task "backup_grog"
run_backup_task "backup_posse_party"
run_backup_task "backup_to_ssd"
run_backup_task "backup_to_nas"
run_backup_task "backup_github"

echo_with_timestamp "----> All backups completed."
