#!/usr/bin/env bash

set -euo pipefail

cd "$HOME"

if [ -L icloud-drive ]; then
  echo "Link 'icloud-drive' already exists"
elif [ -e icloud-drive ]; then
  echo "WARNING: 'icloud-drive' exists but is not a symlink"
else
  ln -s "$HOME/Library/Mobile Documents/com~apple~CloudDocs" icloud-drive
fi

if [ -L lolbrary ]; then
  echo "Link 'lolbrary' already exists"
elif [ -e lolbrary ]; then
  echo "WARNING: 'lolbrary' exists but is not a symlink"
else
  ln -s "$HOME/Library" lolbrary
fi

for link in .Brewfile .config .gemrc .gitconfig .gitignore_global .inputrc .profile .bashrc .vim .vimrc bin .fzf.bash .tmux.conf .netrc .irbrc .codex .claude.json; do
  if [ -L "$HOME/$link" ]; then
    echo "Link '$link' already exists"
  elif [ -e "$HOME/$link" ]; then
    echo "WARNING: '$link' exists but is not a symlink"
  else
    ln -s "icloud-drive/dotfiles/$link" .
  fi
done

touch "$HOME/.hushlogin"
touch "$HOME/.bash_sessions_disable"

mkdir -p "$HOME/.ssh"
cd "$HOME/.ssh"
if [ -L config ]; then
  echo "Link '.ssh/config' already exists"
elif [ -e config ]; then
  echo "WARNING: '.ssh/config' exists but is not a symlink"
else
  ln -s ../icloud-drive/dotfiles/.ssh/config .
fi
cd "$HOME"

mkdir -p "$HOME/.claude"
cd "$HOME/.claude"
for item in CLAUDE.md settings.json hooks; do
  if [ -L "$item" ]; then
    echo "Link '.claude/$item' already exists"
  elif [ -e "$item" ]; then
    echo "WARNING: '.claude/$item' exists but is not a symlink"
  else
    ln -s ../icloud-drive/dotfiles/.claude/"$item" .
  fi
done
mkdir -p "$HOME/.claude/prove_it"
cd "$HOME/.claude/prove_it"
if [ -L config.json ]; then
  echo "Link '.claude/prove_it/config.json' already exists"
elif [ -e config.json ]; then
  echo "WARNING: '.claude/prove_it/config.json' exists but is not a symlink"
else
  ln -s ../../icloud-drive/dotfiles/.claude/prove_it/config.json .
fi
cd "$HOME"

defaults write com.apple.screencapture disable-shadow -bool true
sudo defaults write com.apple.Safari WebKitMediaPlaybackAllowsInline -bool false
sudo defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2AllowsInlineMediaPlayback -bool false
defaults write com.microsoft.VSCode ApplePressAndHoldEnabled -bool false
defaults write com.microsoft.VSCodeInsiders ApplePressAndHoldEnabled -bool false
defaults write -g ApplePressAndHoldEnabled -bool false

if command -v brew >/dev/null 2>&1; then
  echo "Homebrew installed"
else
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

eval "$(/opt/homebrew/bin/brew shellenv)"
brew update
brew bundle --global --no-upgrade

if ! grep -q "^/opt/homebrew/bin/bash$" /etc/shells; then
  echo /opt/homebrew/bin/bash | sudo tee -a /etc/shells >/dev/null
fi

if [ "$SHELL" != "/opt/homebrew/bin/bash" ]; then
  chsh -s /opt/homebrew/bin/bash
fi

export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"
if psql -lqt | cut -d \| -f 1 | grep -qw "$(whoami)"; then
  echo "Default postgres database already exists"
else
  createdb "$(whoami)"
fi

eval "$(nodenv init -)"
NODE_VERSION=$(nodenv install -l | grep -E '^[0-9]+\.' | awk -F. '$1 % 2 == 0' | tail -1)
if [ -d "$HOME/.nodenv/versions/$NODE_VERSION" ]; then
  echo "Node $NODE_VERSION already installed"
else
  echo "Installing Node $NODE_VERSION..."
  nodenv install "$NODE_VERSION"
fi
nodenv global "$NODE_VERSION"

eval "$(rbenv init -)"
RUBY_VERSION=$(rbenv install -l | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | tail -1)
if [ -d "$HOME/.rbenv/versions/$RUBY_VERSION" ]; then
  echo "Ruby $RUBY_VERSION already installed"
else
  echo "Installing Ruby $RUBY_VERSION..."
  rbenv install "$RUBY_VERSION"
fi
rbenv global "$RUBY_VERSION"
gem update --system
gem install bundler htmlbeautifier ripper-tags

cp "$HOME/icloud-drive/dotfiles/launch-agents/"* "$HOME/Library/LaunchAgents"

source "$HOME/.profile"
